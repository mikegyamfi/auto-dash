{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="layout-wrapper layout-content-navbar">
  <div class="layout-container">
    {% include 'inc/side_nav.html' %}
    <div class="layout-page">
      {% include 'inc/header.html' %}

      <div class="content-wrapper">
        <div class="container-xxl flex-grow-1 container-p-y">

          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold mb-0"><span class="text-muted fw-light">Services /</span> Other Services</h4>
            <a class="btn btn-primary" href="{% url 'other_service_create' %}">+ New</a>
          </div>

          <div class="card mb-3">
            <div class="card-body">
              <form method="get" class="row g-3 align-items-end">
                <div class="col-12 col-md-3">
                  <label class="form-label">Status</label>
                  <select class="form-select" name="status">
                    <option value="">All</option>
                    {% for k, v in status_choices.items %}
                      <option value="{{ k }}" {% if selected.status == k %}selected{% endif %}>{{ v }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label">From</label>
                  <input type="date" class="form-control" name="date_from" value="{{ selected.date_from }}">
                </div>
                <div class="col-6 col-md-3">
                  <label class="form-label">To</label>
                  <input type="date" class="form-control" name="date_to" value="{{ selected.date_to }}">
                </div>
                <div class="col-12 col-md-3 d-flex gap-2">
                  <button class="btn btn-primary" type="submit">Apply</button>
                  <a class="btn btn-outline-secondary" href="{% url 'other_service_history' %}">Reset</a>
                </div>
              </form>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-bordered align-middle">
              <thead>
                <tr>
                  <th>When</th>
                  <th>Service</th>
                    <th>Workers</th>
                  <th>Amount</th>
                  <th>Contact</th>
                  <th>Status</th>
                  <th>Revenue</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for x in items %}
                  <tr>
                    <td>{{ x.created_at|date:"Y-m-d H:i" }}</td>
                    <td>
                      <strong>{{ x.service_name }}</strong>
                      {% if x.notes %}<div class="text-muted small">{{ x.notes }}</div>{% endif %}
                    </td>
                      <td>
  {% if x.workers.all %}
    {% for w in x.workers.all %}
      {{ w.user.get_full_name }}{% if not forloop.last %}, {% endif %}
    {% endfor %}
  {% else %}
    <span class="text-muted">—</span>
  {% endif %}
</td>
                    <td>GHS {{ x.amount|floatformat:2|intcomma }}</td>
                    <td>
                      {{ x.contact_name }}{% if x.contact_phone %} — {{ x.contact_phone }}{% endif %}
                    </td>
                    <td>
                      <span class="badge
                        {% if x.status == 'pending' %}bg-secondary
                        {% elif x.status == 'completed' %}bg-success
                        {% elif x.status == 'canceled' %}bg-danger
                        {% elif x.status == 'onCredit' %}bg-warning text-dark
                        {% endif %}">
                        {{ x.get_status_display }}
                      </span>
                    </td>
                    <td>
                      {% if x.revenue_id %}
                        <span class="badge bg-success">Yes</span>
                      {% else %}
                        <span class="text-muted">No</span>
                      {% endif %}
                    </td>
                    <td class="text-nowrap">
                      {% if x.status != 'completed' %}
                        <a class="btn btn-sm btn-outline-success"
                           href="{% url 'other_service_update_status' pk=x.id new_status='completed' %}">
                          Complete
                        </a>
                      {% endif %}
                      {% if x.status != 'onCredit' %}
                        <a class="btn btn-sm btn-outline-warning"
                           href="{% url 'other_service_update_status' pk=x.id new_status='onCredit' %}">
                          On Credit
                        </a>
                      {% endif %}
                      {% if x.status != 'canceled' %}
                        <a class="btn btn-sm btn-outline-danger"
                           href="{% url 'other_service_update_status' pk=x.id new_status='canceled' %}">
                          Cancel
                        </a>
                      {% endif %}
                      {% if x.status != 'pending' %}
                        <a class="btn btn-sm btn-outline-secondary"
                           href="{% url 'other_service_update_status' pk=x.id new_status='pending' %}">
                          Pending
                        </a>
                      {% endif %}
                    </td>
                  </tr>
                {% empty %}
                  <tr><td colspan="7" class="text-center">No entries.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

        </div>
        {% include 'inc/footer.html' %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
