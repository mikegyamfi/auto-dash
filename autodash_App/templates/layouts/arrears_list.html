{% extends 'base.html' %}
{% load static %}

{% block style %}
  {{ block.super }}
  <!-- DataTables CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"
  >
{% endblock style %}

{% block content %}
<div class="layout-wrapper layout-content-navbar">
  <div class="layout-container">
    <!-- Sidebar -->
    {% include 'inc/side_nav.html' %}
    <!-- / Sidebar -->

    <!-- Layout page -->
    <div class="layout-page">
      <!-- Navbar -->
      {% include 'inc/header.html' %}
      <!-- / Navbar -->

      <div class="content-wrapper">
        <div class="container-xxl flex-grow-1 container-p-y">
          <h4 class="fw-bold py-3 mb-4">Arrears (Worker View)</h4>

          <!-- Paid Filter Only -->
          <form method="GET" class="row mb-4 align-items-end">
            <div class="col-md-2">
              <label for="paid_filter" class="form-label">Paid Status</label>
              <select id="paid_filter" name="paid_filter" class="form-control">
                <option value="all" {% if paid_filter == 'all' %}selected{% endif %}>All</option>
                <option value="paid" {% if paid_filter == 'paid' %}selected{% endif %}>Paid</option>
                <option value="unpaid" {% if paid_filter == 'unpaid' %}selected{% endif %}>Unpaid</option>
              </select>
            </div>
            <div class="col-md-2">
              <button type="submit" class="btn btn-primary w-100">Filter</button>
            </div>
          </form>

          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Total Owed: GHS {{ total_owed|floatformat:2 }}</h5>
            </div>
          </div>

          <!-- Arrears Table -->
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Arrears List</h5>
              <div class="table-responsive">
                <table id="myTable" class="table table-bordered table-striped">
                  <thead>
                    <tr>
                      <th>Order #</th>
                      <th>Amount Owed (GHS)</th>
                      <th>Date Created</th>
                      <th>Paid Status</th>
                      <th>Date Paid</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for arr in arrears_list %}
                      <tr data-arrears-id="{{ arr.id }}">
                        <td>
                          <a href="#"
                             class="arrears-details-link"
                             data-arrears-id="{{ arr.id }}">
                            {{ arr.service_order.service_order_number }}
                          </a>
                        </td>
                        <td>{{ arr.amount_owed|floatformat:2 }}</td>
                        <td>{{ arr.date_created|date:"Y-m-d H:i" }}</td>
                        <td>
                          {% if arr.is_paid %}
                            <span class="badge bg-success">Paid</span>
                          {% else %}
                            <span class="badge bg-danger">Unpaid</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if arr.is_paid %}
                            {{ arr.date_paid|date:"Y-m-d H:i" }}
                          {% else %}
                            ---
                          {% endif %}
                        </td>
                        <td>
                          <div class="d-flex flex-wrap gap-2">
                            {% if not arr.is_paid %}
                              <a href="{% url 'mark_arrears_as_paid' arr.id %}"
                                 class="btn btn-sm btn-primary"
                                 onclick="return confirm('Mark this arrears as paid?');">
                                Mark as Paid
                              </a>
                              <a href="{% url 'send_arrears_reminder' arr.id %}"
                                 class="btn btn-sm btn-warning">
                                Send Reminder
                              </a>
                            {% else %}
                              <button class="btn btn-secondary btn-sm" disabled>
                                Already Paid
                              </button>
                            {% endif %}
                          </div>
                        </td>
                      </tr>
                    {% empty %}
                      <tr>
                        <td colspan="6">No arrears found.</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <!-- /Arrears Table -->

        </div>
        {% include 'inc/footer.html' %}
        <div class="content-backdrop fade"></div>
      </div>
    </div>
  </div>
  <div class="layout-overlay layout-menu-toggle"></div>
</div>

<!-- Modal for Arrears/Service Details -->
<div class="modal fade" id="arrearsDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Service Order Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Order Number:</strong> <span id="detail-order-number"></span></p>
        <p><strong>Customer:</strong> <span id="detail-customer"></span></p>
        <p><strong>Date:</strong> <span id="detail-date"></span></p>
        <p><strong>Status:</strong> <span id="detail-status"></span></p>
        <p><strong>Payment Method:</strong> <span id="detail-payment-method"></span></p>
        <p><strong>Final Amount:</strong> GHS <span id="detail-final-amount"></span></p>

        <h6>Vehicle Info</h6>
        <p id="vehicle-info"></p>

        <h6>Workers</h6>
        <ul id="workers-list"></ul>

        <h6>Services</h6>
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Service</th>
              <th>Price (GHS)</th>
            </tr>
          </thead>
          <tbody id="services-list"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block scripts %}
  {{ block.super }}
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script>
    $(document).ready(function() {
      $('#myTable').DataTable();
    });
  </script>

  <!-- Arrears details modal logic -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const detailModalEl = document.getElementById('arrearsDetailModal');
      const detailModal   = new bootstrap.Modal(detailModalEl);

      document.querySelectorAll('.arrears-details-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const id = this.dataset.arrearsId;
          fetch(`/arrears/${id}/details/`)
            .then(res => res.json())
            .then(json => {
              if (json.success) {
                const od = json.data;
                document.getElementById('detail-order-number').textContent  = od.order_number;
                document.getElementById('detail-customer').textContent      = od.customer;
                document.getElementById('detail-date').textContent          = od.date;
                document.getElementById('detail-status').textContent        = od.status;
                document.getElementById('detail-payment-method').textContent= od.payment_method;
                document.getElementById('detail-final-amount').textContent  = parseFloat(od.final_amount).toFixed(2);

                // Vehicle
                const vinfo = document.getElementById('vehicle-info');
                if (od.vehicle) {
                  vinfo.textContent = 
                    `Plate: ${od.vehicle.car_plate}, ` +
                    `Make: ${od.vehicle.car_make}, ` +
                    `Color: ${od.vehicle.car_color}`;
                } else {
                  vinfo.textContent = 'No vehicle info';
                }

                // Workers
                const wlist = document.getElementById('workers-list');
                wlist.innerHTML = '';
                od.workers.forEach(w => {
                  const li = document.createElement('li');
                  li.textContent = w;
                  wlist.appendChild(li);
                });

                // Services
                const slist = document.getElementById('services-list');
                slist.innerHTML = '';
                od.services.forEach(s => {
                  const row = document.createElement('tr');
                  row.innerHTML = `<td>${s.service_type}</td><td>${parseFloat(s.price).toFixed(2)}</td>`;
                  slist.appendChild(row);
                });

                detailModal.show();
              } else {
                alert('Unable to fetch details.');
              }
            })
            .catch(() => alert('Error fetching details.'));
        });
      });
    });
  </script>
{% endblock scripts %}
