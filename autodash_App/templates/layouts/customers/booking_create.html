{# templates/layouts/customers/booking_create.html #}
{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="layout-wrapper layout-content-navbar">
  <div class="layout-container">
    {% include 'inc/side_nav.html' %}
    <div class="layout-page">
      {% include 'inc/header.html' %}
      <div class="content-wrapper">
        <div class="container-xxl flex-grow-1 container-p-y">

          <h3 class="mb-3">Book a Service</h3>

          <div class="card">
            <div class="card-body">
              <form id="log-service-form" method="post">
                {% csrf_token %}
                <div class="row g-3">

                  {# --- Vehicle (with Add Vehicle button) --- #}
                  <div class="col-md-6">
                    <label class="form-label d-flex align-items-center justify-content-between">
                      <span>Vehicle</span>
                      <a
                        class="btn btn-sm btn-outline-success"
                        href="{% url 'customer_vehicle_create' %}?next={{ request.get_full_path|urlencode }}"
                        title="Add a new vehicle"
                      >
                        <i class="bx bx-plus"></i> Add Vehicle
                      </a>
                    </label>
                    {{ form.vehicle }}
                    {% if form.vehicle.errors %}
                      <div class="text-danger small">{{ form.vehicle.errors }}</div>
                    {% endif %}
                    {% if not form.vehicle.field.queryset.exists %}
                      <div class="alert alert-info mt-2 py-2 px-3 small">
                        You don’t have any vehicles yet. Click <strong>Add Vehicle</strong> to register your car, then you can book services for it.
                      </div>
                    {% endif %}
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Branch</label>
                    {{ form.branch }}
                    {% if form.branch.errors %}<div class="text-danger small">{{ form.branch.errors }}</div>{% endif %}
                  </div>

                  <div class="col-12">
                    <label class="form-label">Services (hold Ctrl/⌘ to select multiple)</label>

                    {# Wrap the services select so we can overlay a loader #}
                    <div class="services-select-wrap position-relative">
                      {{ form.services }}
                      <div class="loader-overlay" id="services-loader" aria-hidden="true">
                        <div class="loader-content">
                          <img src="{% static 'img/logo.png' %}" alt="" class="logo-spin" onerror="this.style.display='none'">
                          <div class="css-spinner" aria-label="Loading services"></div>
                        </div>
                      </div>
                    </div>

                    {% if form.services.errors %}<div class="text-danger small">{{ form.services.errors }}</div>{% endif %}
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Scheduled date & time</label>
                    {{ form.scheduled_at }}
                    <div class="form-text">{{ form.fields.scheduled_at.help_text }}</div>
                    {% if form.scheduled_at.errors %}<div class="text-danger small">{{ form.scheduled_at.errors }}</div>{% endif %}
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Driver name</label>
                    {{ form.driver_name }}
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Driver phone</label>
                    {{ form.driver_phone }}
                  </div>

                  <div class="col-12">
                    <label class="form-label">Notes</label>
                    {{ form.notes }}
                  </div>

                  <div class="col-12 d-flex gap-2">
                    <button class="btn btn-primary" type="submit">Create Booking</button>
                    <a class="btn btn-outline-secondary" href="{% url 'customer_service_history' %}">Cancel</a>
                  </div>
                </div>
              </form>
            </div>
          </div>

        </div>
        {% include 'inc/footer.html' %}
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block style %}
<style>
/* --- Services loader overlay --- */
.services-select-wrap select {
  min-height: 180px;
}

.loader-overlay {
  position: absolute;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  backdrop-filter: blur(1.5px);
  background: rgba(255, 255, 255, 0.6);
  border-radius: .5rem;
  z-index: 2;
}

.loader-overlay.show { display: flex; }

.loader-content {
  position: relative;
  display: grid;
  place-items: center;
  gap: 10px;
}

/* If the logo loads, it spins; otherwise we show the CSS spinner below */
.logo-spin {
  width: 48px;
  height: 48px;
  object-fit: contain;
  animation: spin 1.2s linear infinite;
  filter: drop-shadow(0 1px 2px rgba(0,0,0,.15));
}

/* Fallback CSS spinner (nice, subtle) */
.css-spinner {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  border: 3px solid rgba(0,0,0,0.08);
  border-top-color: #0d6efd; /* primary */
  animation: spin .9s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* Dim the select while loading */
.services-select-wrap.loading select {
  opacity: 0.6;
  pointer-events: none;
}
</style>
{% endblock style %}

{% block scripts %}
  <!-- jQuery (if you use it elsewhere) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Bootstrap Bundle JS (if not already loaded globally) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/**
 * Dynamically load the Services list based on the selected Vehicle,
 * with a logo/CSS loader overlay.
 * Assumes field IDs: #id_vehicle and #id_services.
 * Endpoint: {% url 'booking_services_for_vehicle' %}
 * Returns JSON: { "options": [ { "id", "text", "price", "negotiable" }, ... ] }
 */
document.addEventListener('DOMContentLoaded', function () {
  const vehicleSelect   = document.getElementById('id_vehicle');
  const servicesSelect  = document.getElementById('id_services');
  const wrap            = document.querySelector('.services-select-wrap');
  const overlay         = document.getElementById('services-loader');

  if (!vehicleSelect || !servicesSelect || !wrap || !overlay) return;

  function showLoader() {
    wrap.classList.add('loading');
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden', 'false');
    servicesSelect.setAttribute('aria-busy', 'true');
    servicesSelect.disabled = true;
  }

  function hideLoader() {
    wrap.classList.remove('loading');
    overlay.classList.remove('show');
    overlay.setAttribute('aria-hidden', 'true');
    servicesSelect.removeAttribute('aria-busy');
    servicesSelect.disabled = false;
  }

  function clearServices() {
    while (servicesSelect.firstChild) servicesSelect.removeChild(servicesSelect.firstChild);
  }

  function populateServices(options) {
    clearServices();
    (options || []).forEach(function(opt) {
      const o = document.createElement('option');
      o.value = opt.id;
      o.textContent = opt.text;
      // attach meta for SweetAlert fallback
      if (typeof opt.price !== 'undefined') o.setAttribute('data-price', opt.price);
      if (typeof opt.negotiable !== 'undefined') o.setAttribute('data-negotiable', String(!!opt.negotiable));
      servicesSelect.appendChild(o);
    });
  }

  async function loadServicesForVehicle(vehicleId) {
    if (!vehicleId) { clearServices(); return; }
    showLoader();
    try {
      const url = "{% url 'booking_services_for_vehicle' %}" + "?vehicle_id=" + encodeURIComponent(vehicleId);
      const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
      const data = await res.json();
      populateServices((data && data.options) ? data.options : []);
    } catch (e) {
      console.error("Failed to load services:", e);
      clearServices();
    } finally {
      hideLoader();
    }
  }

  // Initial population if vehicle pre-selected (e.g., via ?vehicle=)
  if (vehicleSelect.value) {
    loadServicesForVehicle(vehicleSelect.value);
  }

  // Update services when vehicle changes
  vehicleSelect.addEventListener('change', function () {
    loadServicesForVehicle(this.value);
  });
});
</script>

<script>
/**
 * SweetAlert confirmation showing selected services with prices and negotiable flags before submit.
 * Endpoint: {% url 'booking_service_meta' %}
 * POST JSON: {"ids":[...]} -> { "services":[ {id, name, price, negotiable}, ... ] }
 * Fallback: reads <option data-price / data-negotiable> if endpoint fails.
 */
document.addEventListener('DOMContentLoaded', function () {
  const form           = document.getElementById('log-service-form');
  const servicesSelect = document.getElementById('id_services');
  if (!form || !servicesSelect) return;

  // CSRF for POST fetch
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
  }
  const csrftoken = getCookie('csrftoken');

  // Read data- attrs from <option> as fallback
  function readOptionMeta(ids) {
    const results = [];
    ids.forEach(id => {
      const opt = [...servicesSelect.options].find(o => String(o.value) === String(id));
      if (opt) {
        results.push({
          id: Number(id),
          name: opt.textContent.trim(),
          price: parseFloat(opt.getAttribute('data-price')) || 0,
          negotiable: String(opt.getAttribute('data-negotiable') || '').toLowerCase() === 'true'
        });
      } else {
        results.push({ id: Number(id), name: `Service #${id}`, price: 0, negotiable: false });
      }
    });
    return results;
  }

  async function fetchServiceMeta(ids) {
    try {
      const res = await fetch("{% url 'booking_service_meta' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify({ ids: ids.map(Number) })
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if (!data || !Array.isArray(data.services)) throw new Error("Malformed response");
      return data.services;
    } catch (err) {
      console.warn("Falling back to option meta:", err);
      return readOptionMeta(ids);
    }
  }

  form.addEventListener('submit', async function (e) {
    const selectedIds = [...servicesSelect.selectedOptions].map(o => o.value).filter(Boolean);
    if (!selectedIds.length) return; // let server handle required validation you already have

    e.preventDefault();

    const services = await fetchServiceMeta(selectedIds);

    let total = 0;
    const lines = services.map(s => {
      const price = Number(s.price) || 0;
      total += price;
      const badge = s.negotiable
        ? `<span class="badge bg-warning text-dark ms-2">Negotiable</span>`
        : '';
      return `
        <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
          <div><strong>${s.name}</strong></div>
          <div>GHS ${price.toFixed(2)}</div>
        </div>`;
    }).join('');

    const noteNeeded = services.some(s => s.negotiable);
    const noteHtml = noteNeeded
      ? `<div class="alert alert-info mt-3 mb-0" role="alert" style="font-size:.9rem">
           Note: One or more services are negotiable, so the final amount may change at confirmation. Discounts may also apply.
         </div>`
      : '';

    const html = `
      <div class="text-start">
        ${lines}
        <div class="d-flex justify-content-between align-items-center pt-3">
          <div class="fw-bold">Estimated Total</div>
          <div class="fw-bold">GHS ${total.toFixed(2)}</div>
        </div>
        ${noteHtml}
      </div>
    `;

    const result = await Swal.fire({
      title: 'Confirm Selected Services',
      html,
      confirmButtonText: 'Proceed',
      showCancelButton: true,
      cancelButtonText: 'Review',
      width: 640,
      focusConfirm: false,
    });

    if (result.isConfirmed) {
      form.submit();
    }
  });
});
</script>
{% endblock scripts %}
