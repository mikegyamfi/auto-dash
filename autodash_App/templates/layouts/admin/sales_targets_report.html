{# templates/layouts/admin/sales_targets_report.html #}
{% extends 'base.html' %}
{% load static %}

{% block style %}
<style>
  /* Ensure content sits nicely beside the sidebar */
  .content-wrapper {
    padding-top: 1rem;
    padding-bottom: 1rem;
  }
  /* Card headers */
  .card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
  }
  /* Tighten up the form spacing */
  .filter-row .form-label {
    font-weight: 500;
  }
  /* Chart card padding */
  .card-body canvas {
    width: 100% !important;
  }
</style>
{% endblock style %}

{% block content %}
<div class="layout-wrapper layout-content-navbar">
  <div class="layout-container">

    {% include 'inc/side_nav.html' %}

    <div class="layout-page">
      {% include 'inc/header.html' %}

      <div class="content-wrapper">
        <div class="container-xxl flex-grow-1 container-p-y">

          <h4 class="fw-bold py-3 mb-4">Sales Target Report</h4>

          <form method="get" class="row row-cols-lg-auto align-items-end filter-row g-3 mb-4">
            <div class="col-12 col-md-3">
              <label for="freq" class="form-label">Frequency</label>
              <select name="freq" id="freq" class="form-select" onchange="this.form.submit()">
                <option value="monthly" {% if freq == 'monthly' %}selected{% endif %}>Monthly</option>
                <option value="weekly"  {% if freq == 'weekly'  %}selected{% endif %}>Weekly</option>
              </select>
            </div>

            {% if freq == 'weekly' %}
              <div class="col-12 col-md-3">
                <label for="week_start" class="form-label">Week start</label>
                <input
                  type="date"
                  id="week_start"
                  name="week_start"
                  class="form-control"
                  value="{{ request.GET.week_start }}"
                  onchange="this.form.submit()"
                >
              </div>
            {% else %}
              <div class="col-12 col-md-3">
                <label for="year_month" class="form-label">Month</label>
                <input
                  type="month"
                  id="year_month"
                  name="year_month"
                  class="form-control"
                  value="{{ request.GET.year_month }}"
                  onchange="this.form.submit()"
                >
              </div>
            {% endif %}
          </form>

          <div class="mb-3">
            <strong>Period:</strong> {{ period_label }}
          </div>

          <!-- Comparison table -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Branch Performance</h5>
            </div>
            <div class="card-body table-responsive text-nowrap">
              <table class="table table-striped table-bordered mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Branch</th>
                    <th class="text-end">Revenue (GHS)</th>
                    <th class="text-end">Target (GHS)</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in rows %}
                  <tr>
                    <td>{{ r.branch }}</td>
                    <td class="text-end">{{ r.revenue|floatformat:2 }}</td>
                    <td class="text-end">{{ r.target|floatformat:2 }}</td>
                    <td>
                      {% if r.met %}
                        <span class="badge bg-success">Met</span>
                      {% else %}
                        <span class="badge bg-danger">Missed</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <!-- Hit/Miss history chart -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Hit / Miss History (Last 6 Periods)</h5>
            </div>
            <div class="card-body">
              <canvas id="hitRateChart" height="120"></canvas>
            </div>
          </div>

        </div>
      </div>

      {% include 'inc/footer.html' %}
    </div>
  </div>
  <div class="layout-overlay layout-menu-toggle"></div>
</div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const ctx = document.getElementById('hitRateChart').getContext('2d');
      const labels    = {{ labels|safe }};
      const datasets  = JSON.parse('{{ chart_data|escapejs }}').map(ds => ({
        label: ds.label,
        data: ds.data,
        backgroundColor: ds.data.map(v => v
          ? 'rgba(25, 135, 84, 0.6)'   // greenish for hit
          : 'rgba(220, 53, 69, 0.6)'   // reddish for miss
        ),
        borderWidth: 1
      }));

      new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets },
        options: {
          indexAxis: 'x',
          scales: {
            x: { stacked: true, title: { display: true, text: 'Period' } },
            y: {
              stacked: false,
              beginAtZero: true,
              max: 1,
              title: { display: true, text: 'Hit (1) or Miss (0)' },
              ticks: { stepSize: 1 }
            }
          },
          plugins: {
            legend: { position: 'top' },
            tooltip: { mode: 'index', intersect: false }
          }
        }
      });
    });
  </script>
{% endblock scripts %}
