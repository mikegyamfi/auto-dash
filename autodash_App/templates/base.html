{% load static %}
<!DOCTYPE html>
<html
  lang="en"
  class="light-style layout-menu-fixed"
  dir="ltr"
  data-theme="theme-default"
  data-assets-path="../assets/"
  data-template="vertical-menu-template-free"
>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />

    <title>Auto Dash</title>

    <meta name="description" content="" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="#" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">

    <!-- Icons. Uncomment required icon fonts -->
    <link rel="stylesheet" href="{% static 'assets/vendor/fonts/boxicons.css' %}" />

      <!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.css" />





    <!-- Core CSS -->
    <link rel="stylesheet" href="{% static 'assets/vendor/css/core.css' %}" class="template-customizer-core-css" />
    <link rel="stylesheet" href="{% static 'assets/vendor/css/theme-default.css' %}" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="{% static 'assets/css/demo.css' %}" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="{% static 'assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css' %}" />

    <link rel="stylesheet" href="{% static 'assets/vendor/libs/apex-charts/apex-charts.css' %}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />


    <!-- Page CSS -->

    <!-- Helpers -->
    <script src="{% static 'assets/vendor/js/helpers.js' %}"></script>

    <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
    <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
    <script src="{% static 'assets/js/config.js' %}"></script>

      {% block style %}
      {% endblock style %}
  </head>

  <body>

    {% block content %}
    {% endblock content %}

    {% block scripts %}
    {% endblock scripts %}
    <!-- Core JS -->
    <!-- build:js assets/vendor/js/core.js -->
    <script src="{% static 'assets/vendor/libs/jquery/jquery.js' %}"></script>
    <script src="{% static 'assets/vendor/libs/popper/popper.js' %}"></script>
    <script src="{% static 'assets/vendor/js/bootstrap.js' %}"></script>
    <script src="{% static 'assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.js' %}"></script>

        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script src="{% static 'assets/vendor/js/menu.js' %}"></script>
    <!-- endbuild -->

    <!-- Vendors JS -->
    <script src="{% static 'assets/vendor/libs/apex-charts/apexcharts.js' %}"></script>

    <!-- Main JS -->
    <script src="{% static 'assets/js/main.js' %}"></script>

    <!-- Page JS -->
    <script src="{% static 'assets/js/dashboards-analytics.js' %}"></script>

    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>


<script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
    <!-- Inside the form in edit_branch.html -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>



    <script>
        $(document).ready( function () {
    $('#myTable').DataTable();
} );
    </script>

    <script>
    $(document).ready(function() {
        $('.customer-select').select2({
            placeholder: "Select services",
            allowClear: true,
        });
    });
</script>

  <script>
        {% for msg in messages %}
            {% if msg.tags == "success" %}
            Swal.fire({
                text: '{{ msg }}',
                icon: 'success',
                timer: 1000
            })
            {% elif msg.tags == "warning" %}
            Swal.fire({
                text: '{{ msg }}',
                icon: 'info',
                timer: 1500
            })
            {% elif msg.tags == "info" %}
            Swal.fire({
                text: '{{ msg }}',
                icon: 'info',
            })
            {% else %}
            Swal.fire({
                text: '{{ msg }}',
                icon: 'error',
                timer: 1000
            })
            {% endif %}
        {% endfor %}
    </script>

  <script>
    $(document).ready(function() {
      // Initialize Select2 on customer, vehicle, service, and workers selects
      $('#{{ form.customer.id_for_label }}').select2({
        placeholder: 'Select Customer',
        width: '100%'
      });
      $('#{{ form.vehicle.id_for_label }}').select2({
        placeholder: 'Select Vehicle',
        width: '100%'
      });
      $('#{{ form.service.id_for_label }}').select2({
        width: '100%'
      });
      $('#{{ form.workers.id_for_label }}').select2({
        width: '100%'
      });

      // When typing in the dedicated search inputs, open the corresponding Select2 dropdown
      $('#customer-search').on('input', function() {
        $('#{{ form.customer.id_for_label }}').select2('open');
      });
      $('#vehicle-search').on('input', function() {
        $('#{{ form.vehicle.id_for_label }}').select2('open');
      });

      // AJAX: Create new customer
      $('#new-customer-form').on('submit', function(event) {
        event.preventDefault();
        var formData = new FormData(this);
        $('#loadingSpinner').show();
        $.ajax({
          url: "{% url 'create_customer' %}",
          method: "POST",
          data: formData,
          processData: false,
          contentType: false,
          headers: { 'X-CSRFToken': '{{ csrf_token }}' },
          success: function(data) {
            $('#loadingSpinner').hide();
            if(data.success) {
              var newOption = new Option(data.customer.name, data.customer.id, true, true);
              $('#{{ form.customer.id_for_label }}').append(newOption).trigger('change');
              $('#new-customer-modal').modal('hide');
              $('#new-customer-form')[0].reset();
            } else {
              alert("Error creating customer: " + data.error);
            }
          },
          error: function(xhr, status, error) {
            $('#loadingSpinner').hide();
            console.error("AJAX Error: ", error);
          }
        });
      });

      // AJAX: Create new vehicle
      $('#new-vehicle-form').on('submit', function(event) {
        event.preventDefault();
        var formData = new FormData(this);
        $('#loadingSpinner').show();
        $.ajax({
          url: "{% url 'create_vehicle' %}",
          method: "POST",
          data: formData,
          processData: false,
          contentType: false,
          headers: { 'X-CSRFToken': '{{ csrf_token }}' },
          success: function(data) {
            $('#loadingSpinner').hide();
            if(data.success) {
              var newVehOption = new Option(data.vehicle.display, data.vehicle.id, true, true);
              $('#{{ form.vehicle.id_for_label }}').append(newVehOption).trigger('change');
              $('#new-vehicle-modal').modal('hide');
              $('#new-vehicle-form')[0].reset();
            } else {
              alert("Error creating vehicle: " + data.error);
            }
          },
          error: function(xhr, status, error) {
            $('#loadingSpinner').hide();
            console.error("AJAX Error: ", error);
          }
        });
      });

      // Ensure a customer is selected before allowing new vehicle creation
      $('#new-vehicle-btn').on('click', function() {
        var customerId = $('#{{ form.customer.id_for_label }}').val();
        if (!customerId) {
          alert("Please select a customer first.");
          $('#new-vehicle-modal').modal('hide');
          return;
        }
        $('#new-vehicle-customer-id').val(customerId);
      });

      // Auto-populate vehicles when customer changes via AJAX
      $('#{{ form.customer.id_for_label }}').on('change', function() {
        var customerId = $(this).val();
        var vehicleSelect = $('#{{ form.vehicle.id_for_label }}');
        vehicleSelect.empty().append(new Option("Select Vehicle", ""));
        if (customerId) {
          $('#loadingSpinner').show();
          $.ajax({
            url: "/get_customer_vehicles/" + customerId + "/",
            method: "GET",
            success: function(data) {
              $('#loadingSpinner').hide();
              if(data.vehicles) {
                data.vehicles.forEach(function(v) {
                  var option = new Option(v.display, v.id);
                  vehicleSelect.append(option);
                });
                vehicleSelect.trigger('change');
              }
            },
            error: function(xhr, status, error) {
              $('#loadingSpinner').hide();
              console.error("Error fetching vehicles: ", error);
            }
          });
        }
      });

      // Auto-populate services when vehicle changes via AJAX
      $('#{{ form.vehicle.id_for_label }}').on('change', function() {
        var vehicleId = $(this).val();
        var serviceSelect = $('#{{ form.service.id_for_label }}');
        serviceSelect.empty();
        if (vehicleId) {
          $('#loadingSpinner').show();
          $.ajax({
            url: "/get_vehicle_services/" + vehicleId + "/",
            method: "GET",
            success: function(data) {
              $('#loadingSpinner').hide();
              if(data.services && data.services.length > 0) {
                data.services.forEach(function(svc) {
                  var option = new Option(svc.name, svc.id);
                  $(option).attr('data-negotiable', svc.negotiable ? 'true' : 'false');
                  serviceSelect.append(option);
                });
                serviceSelect.trigger('change');
              } else {
                serviceSelect.append(new Option("No services available for this vehicle", ""));
              }
            },
            error: function(xhr, status, error) {
              $('#loadingSpinner').hide();
              console.error("Error fetching services: ", error);
            }
          });
        }
      });

      // Dynamic negotiable fields for selected services
      var negotiableContainer = document.getElementById('negotiable-services-container');
      var negotiatedPricesHidden = document.getElementById('negotiated-prices-hidden');
      var negotiatedPrices = {};

      $('#{{ form.service.id_for_label }}').on('change', function() {
        negotiableContainer.innerHTML = '';
        negotiatedPrices = {};
        var selectedOptions = $(this).find(':selected');
        if (selectedOptions.length === 0) {
          negotiableContainer.style.display = 'none';
          return;
        }
        var anyNegotiable = false;
        selectedOptions.each(function() {
          var svcId = $(this).val();
          var isNegotiable = $(this).attr('data-negotiable') === 'true';
          if (svcId && isNegotiable) {
            anyNegotiable = true;
            var div = document.createElement('div');
            div.classList.add('mb-2');
            div.innerHTML = '<label class="form-label">Negotiated Price for "' + $(this).text() + '":</label>' +
                            '<input type="number" step="0.01" min="0" class="form-control negotiated-price-input" data-service-id="' + svcId + '" placeholder="Enter final price in GHS">';
            negotiableContainer.appendChild(div);
          }
        });
        negotiableContainer.style.display = anyNegotiable ? 'block' : 'none';
      });

      // On form submit, gather negotiated price inputs into hidden field
      $('#log-service-form').on('submit', function() {
        var priceInputs = negotiableContainer.querySelectorAll('.negotiated-price-input');
        priceInputs.forEach(function(input) {
          var svcId = input.getAttribute('data-service-id');
          var val = parseFloat(input.value) || 0;
          negotiatedPrices[svcId] = val;
        });
        negotiatedPricesHidden.value = JSON.stringify(negotiatedPrices);
      });

    });
  </script>
  </body>
</html>